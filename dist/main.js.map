{"version":3,"file":"main.js","sources":["../src/main.ts"],"sourcesContent":["const puppeteer = require('puppeteer');\nconst { promisify } = require('util');\nconst read = promisify(require('read'));\nconst { Spinner } = require('cli-spinner');\nconst { chromeCanary: chromeCanaryPath } = require('chrome-paths');\nconst fs = require('fs');\n\nconst hurl = (error) => { throw new Error(error) }\nconst nop = () => undefined;\n\nconst AsyncFunction = Object.getPrototypeOf(async function(){}).constructor\nconst isAsyncFunction = (fn) => fn.constructor == AsyncFunction;\n\nclass BirdBox {\n\tconstructor() {\n\n\t}\n\n\tdisplayLoading(fn, name, {clear = true} = {}) {\n\t\treturn async (...args) => {\n\t\t\tconst s = new Spinner({\n\t\t\t\ttext: `%s ${name}(${args.join(\", \")})`.replace(/\\n/g, \"\\\\n\")\n\t\t\t});\n\n\t\t\ts.setSpinnerString(20);\n\n\t\t\ts.start();\n\n\t\t\tconst out = await fn(...args);\n\n\t\t\ts.stop(clear);\n\n\t\t\treturn out;\n\t\t}\n\t}\n\n\tenhanceAsyncToDisplayLoading(obj) {\n\t\treturn new Proxy(obj, {\n\t\t\tget: (...args) => {\n\t\t\t\tconst [target, prop] = args;\n\t\t\t\tconst v = Reflect.get(...args);\n\t\t\t\tif (typeof v == \"function\") return this.displayLoading(\n\t\t\t\t\tv.bind(target),\n\t\t\t\t\tString(prop),\n\t\t\t\t);\n\n\t\t\t\treturn v;\n\t\t\t}\n\t\t})\n\t}\n\n\tasync toggleMic(page) {\n\t\tconst micButton = \".player-button.talkback\"\n\t\tawait page.show.waitForSelector(micButton, { visible: true });\n\t\tawait page.show.click(micButton);\n\t}\n\n\tasync fill2fa(page) {\n\t\tconst mfaFields = \".mfa-fields input\";\n\t\tawait page.show.waitForSelector(mfaFields)\n\t\tawait page.show.click(mfaFields)\n\n\t\tawait page.show.type(mfaFields, await read({ prompt: \"2fa code\" }) +\"\\n\", {delay: 100});\n\n\t\tconst signinButton = \".mfa-passcode-view-buttons\";\n\t\tawait page.show.waitForSelector(signinButton);\n\t\tawait page.show.click(signinButton, '#verify-pin-button');\n\t}\n\n\n\tasync logIn(page) {\n\t\tconsole.log(\"it looks like you're logged out!\");\n\t\tconst emailInput = \".email-input input\";\n\t\tawait page.show.waitForSelector(emailInput, { visible: true });\n\t\tawait page.show.click(emailInput);\n\t\tawait page.show.type(emailInput, await read({ prompt: \"email:\" }));\n\n\n\t\tconst passInput = \".pass-input input\";\n\t\tawait page.show.waitForSelector(passInput, { visible: true});\n\t\tawait page.show.click(passInput);\n\t\tawait page.show.type(passInput, await read({\n\t\t\tprompt: \"password:\",\n\t\t\tsilent: true,\n\t\t\treplace: \"ãƒ»\"\n\t\t}));\n\n\t\tconst signinButton = \".signin-button-container input\";\n\t\tawait page.show.click(signinButton);\n\n\t\ttry {\n\t\t\tawait page.show.waitForSelector(\".mfa-fields\", { visible: true});\n\t\t\tawait this.fill2fa(page);\n\t\t} catch (e) { console.log(e) }\n\t}\n\n\thandleErrors(page) {\n\t\tpage.waitForSelector(\".error-msg\", { timeout: 0, visible: true }).then(\n\t\t\t(elem: Element) => {  throw new Error(elem.textContent) });\n\t}\n\n\tasync _getState(page, { timeout = 10000 } = {}) {\n\t\treturn await Promise.race([\n\t\t\tpage.waitForSelector(\".pass-input\", { visible: true }).then(v => \"login\"),\n\t\t\tpage.waitForSelector('a[href^=\"/camera\"]', { visible: true }).then(v => \"home\"),\n\t\t\tnew Promise((resolve, reject) => setTimeout(() => resolve(\"UNKNOWN\"), timeout))\n\t\t]).catch((e) => console.log(e));\n\n\t}\n\n\tasync getState(page, options?) {\n\t\treturn await this.displayLoading(this._getState, \"getState\")(page, options || {})\n\t}\n\n\tasync mustGetState(p, options?) {\n\t\tconst page = await this.getState(p, options);\n\t\tif (page == \"UNKNOWN\") throw \"we find ourselves in an unknown state\";\n\n\t\treturn page;\n\t}\n\n\tasync main(page) {\n\t\tawait page.show.goto('https://home.nest.com');\n\t\tthis.handleErrors(page);\n\n\t\tif (await this.mustGetState(page, {}) == \"login\") await this.logIn(page);\n\t\tif (await this.mustGetState(page, {}) != \"home\") throw \"expected to be home by now...\";\n\n\t\tconst cameraLink = 'a[href^=\"/camera\"]';\n\t\tawait page.show.waitForSelector(cameraLink);\n\t\tawait page.show.click(cameraLink);\n\n\t\tawait this.toggleMic(page);\n\t}\n\n\tasync run() {\n\t\t// is chrome canary installled and can we access it?\n\t\tawait new Promise(\n\t\t\t(ok, fail) => fs.access(\n\t\t\t\tchromeCanaryPath,\n\t\t\t\tfs.X_OK,\n\t\t\t\t(err) => err?fail(`please install chrome canary to ${chromeCanaryPath}`):ok() )\n\t\t\t);\n\n\t\tconst browser = await puppeteer.launch({\n\t\t\theadless: process.env.NODE_ENV == 'production',\n\t\t\tuserDataDir: \"./browser_data\",\n\t\t\texecutablePath: chromeCanaryPath,\n\t\t\tdumpio: true,\n\t\t\targs: [\n\t\t\t\t// prevents showing user confirmation we cant click\n\t\t\t\t// to use the mic\n\t\t\t\t\"--use-fake-ui-for-media-stream\",\n\n\t\t\t\t\"--use-fake-device-for-media-stream\",\n\n\t\t\t\t// plays a test sound instead of using a real mic\n\t\t\t\t\"--use-file-for-fake-audio-capture=dist/wii-shop-music.wav\"\n\t\t\t]\n\t\t});\n\n\n\t\ttry {\n\t\t\tconst page = await browser.newPage();\n\t\t\tpage.show = this.enhanceAsyncToDisplayLoading(page);\n\n\n\t\t\tawait this.main(page)\n\n\t\t\tconsole.log(\"completed all tasks. dropping to selector REPL.\")\n\t\t\tfor (;;) {\n\t\t\t\tconsole.log(await page.$(await read({ prompt: \"query\" })))\n\t\t\t}\n\t\t} catch(e) {\n\t\t\tconst ssloc = \"screenshot.png\";\n\t\t\tconsole.log(e);\n\t\t\tconsole.log(\"a fatal error has occurred.\");\n\t\t\tawait browser.screenshot({ path: ssloc });\n\t\t\tconsole.log(`a screenshot of the browser at crash time has been saved as ${ssloc}`);\n\t\t} finally { await browser.close() }\n\n\t}\n}\n\n\nnew BirdBox().run();\n"],"names":[],"mappings":"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"}